<!DOCTYPE html>
<html lang="zh-Hans">

<head>
    <meta charset="utf-8"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>栈缓冲区溢出之二 ASLR | dontpan1c 的 CTF 笔记</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="栈缓冲区溢出之二 ASLR" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="上文介绍了栈缓冲区溢出的基本情况与利用方法。栈缓冲区溢出之后，如果没有任何防护措施，攻击者可以非常容易地改变程序执行逻辑，甚至可以执行注入的代码。为了降低栈缓冲区溢出漏洞发生后的风险，很多技术应运而生，ASLR（Address Space Layout Randomization，地址空间布局随机化）就是其中之一。" />
<meta property="og:description" content="上文介绍了栈缓冲区溢出的基本情况与利用方法。栈缓冲区溢出之后，如果没有任何防护措施，攻击者可以非常容易地改变程序执行逻辑，甚至可以执行注入的代码。为了降低栈缓冲区溢出漏洞发生后的风险，很多技术应运而生，ASLR（Address Space Layout Randomization，地址空间布局随机化）就是其中之一。" />
<link rel="canonical" href="https://ctf.dontpanic.blog/notes/stack-buffer-overflow-aslr.html" />
<meta property="og:url" content="https://ctf.dontpanic.blog/notes/stack-buffer-overflow-aslr.html" />
<meta property="og:site_name" content="dontpan1c 的 CTF 笔记" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-19T00:00:00+00:00" />
<script type="application/ld+json">
{"description":"上文介绍了栈缓冲区溢出的基本情况与利用方法。栈缓冲区溢出之后，如果没有任何防护措施，攻击者可以非常容易地改变程序执行逻辑，甚至可以执行注入的代码。为了降低栈缓冲区溢出漏洞发生后的风险，很多技术应运而生，ASLR（Address Space Layout Randomization，地址空间布局随机化）就是其中之一。","@type":"BlogPosting","url":"https://ctf.dontpanic.blog/notes/stack-buffer-overflow-aslr.html","headline":"栈缓冲区溢出之二 ASLR","dateModified":"2019-02-19T00:00:00+00:00","datePublished":"2019-02-19T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ctf.dontpanic.blog/notes/stack-buffer-overflow-aslr.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/fontawesome.min.css">
    <script src="/assets/js/index.js"></script>
</head>

<body>
    <div class="d-flex flex-grow-1 flex-column h-100">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="/">dontpan1c 的 CTF 笔记</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor03"
                aria-controls="navbarColor03" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarColor03">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://dontpanic.blog" target="_blank">博客</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://dontpanic.blog/about" target="_blank">关于</a>
                    </li>
                </ul>
                <ul class="navbar-nav dp-navbar-right">
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/dontpanic92/ctf-writeups" target="_blank">
                            <i class="fab fa-github"></i><span>&nbsp;仓库</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/feed.xml" target="_blank">
                            <i class="fas fa-rss"></i><span>&nbsp;订阅</span>
                        </a>
                    </li>
                </ul>
                <form class="form-inline my-2 my-lg-0" action="/search" method="GET">
                    <input name="query" class="form-control mr-sm-2" type="text" placeholder="搜索">
                    <button class="btn btn-secondary my-2 my-sm-0" type="submit">搜索</button>
                </form>
            </div>
        </nav>
        <div class="d-flex flex-grow-1 h-100 container pt-3 justify-content-center">
            <div class="col-3">
    <div class="list-group border-primary">
        <a class="list-group-item list-group-item-action " href="/">
            <h6><strong>孤舟蓑笠翁</strong></h6>
            <span class="font-weight-light">独钓寒江雪。CTF 解题报告</span>
        </a>
        <a class="list-group-item list-group-item-action active" href="/notes">
            <h6><strong>温故而知新</strong></h6>
            <span class="font-weight-light">可以为师矣。知识笔记</span>
        </a>
        <a class="list-group-item list-group-item-action " href="/cheatsheets">
            <h6><strong>愿君多采撷</strong></h6>
            <span class="font-weight-light">此物最相思。Cheatsheets</span>
        </a>
        <a class="list-group-item list-group-item-action " href="/tools">
            <h6><strong>工欲善其事</strong></h6>
            <span class="font-weight-light">必先利其器。实用工具索引</span>
        </a>
        <!--a class="list-group-item list-group-item-action">
            海内存知己
        </a-->
    </div>
    <div class="card mt-5">
        <div class="card-header">
            近期发布
        </div>
        <div class="list-group list-group-flush">
            
            <a class="list-group-item list-group-item-action" href="/writeups/reversing-kr-replace.html">
                <h6><strong>Replace</strong></h6>
                <span class="font-weight-light"><p>打开程序后弹出了一个对话框，文本框中似乎只能输入数字，输入错误的话程序会直接退出，有时还会崩溃：</p>
</span>
                <small>2019年03月13日 | writeups | reversing</small>
            </a>
            
            <a class="list-group-item list-group-item-action" href="/writeups/reversing-kr-easy-keygenme.html">
                <h6><strong>Easy KeygenMe</strong></h6>
                <span class="font-weight-light"><p>题目要求 Find the Name when the Serial is 5B134977135E7D13：</p>
</span>
                <small>2019年03月12日 | writeups | reversing</small>
            </a>
            
            <a class="list-group-item list-group-item-action" href="/notes/stack-buffer-overflow-canary.html">
                <h6><strong>栈缓冲区溢出之三 Security Cookie / Canary</strong></h6>
                <span class="font-weight-light"><p>当栈溢出发生时，如果能够检测到栈溢出已经发生，就可以及时中止程序的执行，从而能够避免继续走攻击者安排好的路。Windows 上的 Security Cookie 就是这样一种机制。在 Linux 上，Canary 这个名字更常用。不论是 Security Cookie 还是 Canary，它们的原理都是相同的。</p>
</span>
                <small>2019年02月28日 | notes | binary</small>
            </a>
            
            <a class="list-group-item list-group-item-action" href="/writeups/picoctf-2018-buffer-overflow-3.html">
                <h6><strong>Buffer Overflow 3</strong></h6>
                <span class="font-weight-light"><p>这道题模拟了栈溢出保护，但 canary 是固定的：</p>
</span>
                <small>2019年02月27日 | writeups | pwn</small>
            </a>
            
            <a class="list-group-item list-group-item-action" href="/writeups/picoctf-2018-buffer-overflow-012.html">
                <h6><strong>Buffer Overflow 0 / 1 / 2</strong></h6>
                <span class="font-weight-light"><p>因为这几道题都比较简单，所以合并在一起了：</p>
</span>
                <small>2019年02月26日 | writeups | pwn</small>
            </a>
            
        </div>
    </div>
</div>
<div id="content" class="col-8 pl-4">
    <h1>栈缓冲区溢出之二 ASLR</h1>
<span class="d-block"><small>发布日期：2019年02月19日</small></span>
<span class="d-block"><small>类别：binary</small></span>



<hr />
<p><a href="/notes/stack-buffer-overflow-101.html">上文</a>介绍了栈缓冲区溢出的基本情况与利用方法。栈缓冲区溢出之后，如果没有任何防护措施，攻击者可以非常容易地改变程序执行逻辑，甚至可以执行注入的代码。为了降低栈缓冲区溢出漏洞发生后的风险，很多技术应运而生，ASLR（Address Space Layout Randomization，地址空间布局随机化）就是其中之一。</p>
<p>由于缓冲区溢出后，攻击者通常需要需要跳转到某些特定的系统函数、或是跳转到堆栈上执行，ASLR 的基本思想就是随机化动态库和堆栈空间的地址。这样就使得每次程序启动时，它们的地址都会发生变化，使得攻击者难以确定需要跳转到的目标地址。</p>
<h3 id="查看系统是否开启-aslr">查看系统是否开启 ASLR</h3>
<h4 id="windows">Windows</h4>
<p>Windows 自从 Vista 后全面支持了 ASLR 保护。在新版 Windows 10 中，可以在安全中心设置是否开启这一功能：</p>
<p><img src="/assets/local/posts/stack-buffer-overflow-aslr/windows-aslr-settings.jpg" alt="windows-aslr-settings" /></p>
<p>设置中的 “Mandatory ASLR” 是指，如果一个程序没有使用 <code>/DYNAMICBASE</code> 选项编译时，是否仍然要随机地址空间。由于兼容性问题存在，这项设置默认关闭。</p>
<h4 id="linux">Linux</h4>
<p>Linux 系统中，我们可以通过 <code>/proc/sys/kernel/randomize_va_space</code> 来查看或开启/关闭 ASLR：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">dontpanic@Ubuntu</span>:~$ cat /proc/sys/kernel/randomize_va_space</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ex">2</span></a></code></pre></div>
<p>2 表示 ASLR 完全开启。设置为 0 时即为关闭。</p>
<h3 id="为程序启用-aslr">为程序启用 ASLR</h3>
<p>由于启用了 ASLR 后，程序的加载位置会随机变化，因此这还需要编译器的支持。GCC 可以通过使用 <code>-pie</code> 选项（默认开启）来生成位置无关的代码，从而使得程序能够支持 ASLR。使用 <code>-no-pie</code> 不会生成位置无关代码。这两种方式生成的可执行文件的信息是不同的：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="ex">dontpanic@Ubuntu</span>:~$ gcc -no-pie test.c</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="ex">dontpanic@Ubuntu</span>:~$ file a.out</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="ex">a.out</span>: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), <span class="ex">dynamically</span> linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=b6a30608d5278aba091e7f52f2a7fd25e7c745a9, not stripped</a>
<a class="sourceLine" id="cb2-4" title="4"><span class="ex">dontpanic@Ubuntu</span>:~$</a>
<a class="sourceLine" id="cb2-5" title="5"><span class="ex">dontpanic@Ubuntu</span>:~$</a>
<a class="sourceLine" id="cb2-6" title="6"><span class="ex">dontpanic@Ubuntu</span>:~$ gcc -pie test.c</a>
<a class="sourceLine" id="cb2-7" title="7"><span class="ex">dontpanic@Ubuntu</span>:~$ file a.out</a>
<a class="sourceLine" id="cb2-8" title="8"><span class="ex">a.out</span>: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), <span class="ex">dynamically</span> linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=75017e995c8e398060095542ea11b2bb1445a965, not stripped</a>
<a class="sourceLine" id="cb2-9" title="9"><span class="ex">dontpanic@Ubuntu</span>:~$</a></code></pre></div>
<p>在系统启用了 ASLR 时，通过 <code>/proc/PID/maps</code> 将可以看到，每次执行时程序所需要的动态库和堆栈空间的加载位置都不同。如果程序启用了 <code>-pie</code>，将会看到可执行文件自身的加载地址也会发生变化。</p>
<p>在 Windows 上，MSVC 的编译选项 <code>/DYNAMICBASE</code> 具有类似的效果。</p>
<div class="alert alert-light border-info" markdown="1">
<h5><i class="fas fa-exclamation"></i> Notes</h5>
<p>新版 GDB 在调试时会默认关闭被调试程序的 ASLR。可以通过命令 <code>set disable-randomization off</code> 重新启用。</p>
</div>
<h3 id="绕过-aslr">绕过 ASLR</h3>
<p>在某些情况下，我们可以绕过 ASLR 的防护。例如，</p>
<ol type="1">
<li>如果缓冲区足够大，当希望跳转至缓冲区中执行指令时，可以尝试通过大量填充 <code>NOP</code> 使得跳转成功的机率增加。</li>
<li>某个寄存器中的值刚好指向了我们需要的地址。</li>
<li>通过某些方式泄露出动态库的加载地址。
<div>
<a href='/writeups/picoctf-2013-rop-3.html'>
<div class="alert alert-success">
<i class='fas fa-pencil-alt'></i> 相关题目：ROP 3
</div>
</a>
</div></li>
<li>2016 年的<a href="http://www.cs.ucr.edu/~nael/pubs/micro16.pdf">一篇论文</a>指出，可以利用分支指令通过旁路探测出模块加载的地址。</li>
</ol>
<h3 id="内核地址空间随机化">内核地址空间随机化</h3>
<p>内核同样可以开启 ASLR，这项技术在 Linux 中被称作 KASLR。但由于 <a href="https://www.zhihu.com/question/265012502/answer/288407097">2018 年 Intel CPU 所暴露出的漏洞</a>，KASLR 不再安全。目前 KASLR 已被 KPTI（内核页表隔离）所取代。</p>


</div>

        </div>
        <div class="mt-5 p-5 bg-light text-muted">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-4">
                        <h5>dontpan1c 的 CTF 笔记</h5>
                        <span class="d-block font-weight-light">南阳一出即相，淮阴一出即将。</span>
                        <div class="btn-toolbar mt-4">
                            <div class="btn-group">
                              <a class="btn btn-secondary" href="https://github.com/dontpanic92"
                              target="_blank"><i class="fab fa-fw fa-github"></i></a>
                              <a class="btn btn-secondary" href="https://zhihu.com/people/li-sheng-qiu"
                              target="_blank"><i class="fab fa-fw fa-zhihu"></i></a>
                              <a class="btn btn-secondary" href="https://weibo.com/1184181045/profile"
                              target="_blank"><i class="fab fa-fw fa-weibo"></i></a>
                              <a class="btn btn-secondary" href="https://linkedin.com/in/lishengqiu"
                              target="_blank"><i class="fab fa-fw fa-linkedin-in"></i></a>
                              <a class="btn btn-secondary" href="https://stackoverflow.com/users/3196456"
                              target="_blank"><i class="fab fa-fw fa-stack-overflow"></i></a>
                              <a class="btn btn-secondary" href="http://renren.com/419200039"
                              target="_blank"><i class="fab fa-fw fa-renren"></i></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <p><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license"><img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"
                                    alt="知识共享许可协议"></a></p>
                        <p><small>本站所有作品均采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license">知识共享署名-非商业性使用-相同方式共享
                                    4.0 国际许可协议</a>进行许可。</small></p>
                        <p><small>本站不包含明令禁止公开解题过程的题目。</small></p>
                        <span><small>本站由 <a href="https://jekyllrb.com/" target="_blank">Jekyll</a> 强力驱动。</small></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>